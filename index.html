<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n-key="title">IPPM Analyzer</title>
  <style>
    /* ---------------------------------- */
    /* 1. Base Variables (Dark Mode Default) */
    /* ---------------------------------- */
    :root {
      --bg: #0d0f11;
      --card: #161a1d;
      --muted: #7d8b92;
      --accent: #00bcd4; /* Brighter Cyan */
      --danger: #ff4a60;
      --success: #32d664;
      --warning: #ffb700;
      --text: #e8eef0;
      --input-bg: #252a30;
      --input-border: #3c4146;
      --radius: 8px;
      --shadow: 0 4px 18px rgba(0, 0, 0, 0.45);
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color-scheme: dark;
      transition: all 0.3s ease;
    }

    /* ---------------------------------- */
    /* 2. Light Mode Variables */
    /* ---------------------------------- */
    [data-theme="light"] {
        --bg: #f5f8fa;
        --card: #ffffff;
        --muted: #6b7785;
        --accent: #007bff; 
        --danger: #dc3545;
        --success: #28a745;
        --warning: #ffc107;
        --text: #1f2933;
        --input-bg: #eaf0f6;
        --input-border: #cdd5df;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        color-scheme: light;
    }

    * {
      box-sizing: border-box;
      direction: ltr; /* Default LTR, adjusted by JS for HE */
    }
    html[lang="he"] * {
        direction: rtl;
        text-align: right;
    }

    body {
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      margin: 0;
      text-align: left;
      transition: background 0.3s, color 0.3s;
    }

    .wrap {
      max-width: 960px;
      margin: 0 auto;
    }

    header {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 24px;
      justify-content: space-between;
    }

    .header-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    h1 {
      font-size: 28px;
      margin: 0 0 4px;
      color: var(--accent);
      font-weight: 700;
    }

    p.lead {
      margin: 0;
      color: var(--muted);
      font-size: 15px;
    }

    .main {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
    }

    .left,
    .right {
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: background 0.3s, box-shadow 0.3s;
    }
    
    .left h2, .right h2 {
        font-size: 20px;
        margin-top: 0;
        border-bottom: 1px solid var(--input-border);
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    /* Input and Form Elements */
    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }
    
    html[lang="he"] label {
        text-align: right;
    }

    input:not([type="checkbox"]),
    select,
    button {
      width: 100%;
      padding: 12px 10px;
      border-radius: 6px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 16px;
      transition: border-color 0.2s, background 0.2s;
    }
    input[type="number"] {
        width: auto;
        -moz-appearance: textfield; 
    }
    input[type="number"]::-webkit-inner-spin-button, 
    input[type="number"]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
    }
    
    input:focus,
    select:focus {
      border-color: var(--accent);
      outline: 1px solid var(--accent);
    }

    /* Slider Component */
    input[type="range"] {
        -webkit-appearance: none;
        height: 8px;
        background: var(--input-border);
        border-radius: 5px;
        margin: 7px 0;
        cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
        transition: background 0.2s;
    }

    /* Buttons */
    .btn-group {
      display: flex;
      gap: 5px;
    }

    .btn-group button {
      width: 40px;
      padding: 0;
      font-size: 18px;
      background: var(--input-border);
      color: var(--text);
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-group button:hover {
        background: var(--accent);
        color: var(--card);
    }
    
    .input-with-btns {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .input-with-btns input {
        flex-grow: 1;
    }
    
    .input-with-btns .btn-group button {
        height: 44px;
    }


    /* --- ISSUES / CHECKBOX STYLES --- */
    #issuesList {
      margin-top: 10px;
      padding: 10px;
      border: 1px dashed var(--input-border);
      border-radius: var(--radius);
    }
    
    #issuesList > div { 
        margin-bottom: 12px;
        padding: 10px;
        border: 2px solid var(--card);
        border-radius: 6px;
        background: var(--input-bg);
        transition: border 0.3s, box-shadow 0.3s, background 0.3s;
        cursor: pointer;
    }
    
    /* Glowing Border for Selected Issue */
    #issuesList > div.selected-issue {
        border-color: var(--accent);
        box-shadow: 0 0 8px rgba(0, 188, 212, 0.4);
        background: color-mix(in srgb, var(--input-bg), var(--accent) 5%); 
    }

    .issue-manual-cost {
        display: flex;
        gap: 10px;
        margin-top: 8px;
        padding-left: 20px; 
        align-items: center;
    }
    .issue-manual-cost input {
        width: 80px;
        text-align: center;
        padding: 5px;
        font-size: 14px;
        height: 30px;
    }
    .issue-manual-cost label {
        color: var(--muted);
        font-size: 12px;
        margin-bottom: 0;
        font-weight: normal;
    }
    .issue-checkbox {
        display: none;
    }
    .issue-label-text {
        font-size: 15px;
        color: var(--text);
        font-weight: 500;
    }
    /* RTL adjustments for issue list */
    html[lang="he"] .issue-manual-cost {
        padding-left: 0;
        padding-right: 20px;
    }
    html[lang="he"] .issue-label-text {
        text-align: right;
    }
    /* --- END ISSUES STYLES --- */

    /* Summary and Results */
    .summary-box {
        margin-top: 25px;
        border: 1px solid var(--accent);
        padding: 18px;
        border-radius: var(--radius);
        background: color-mix(in srgb, var(--card), var(--accent) 3%);
    }
    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 16px;
        font-weight: 500;
    }
    .summary-item span:first-child {
        color: var(--muted);
    }
    .summary-item.total-offer span:last-child {
        font-size: 20px;
        color: var(--warning);
        font-weight: 700;
    }
    .summary-item.profit-margin span:last-child {
        color: var(--success);
    }
    .summary-item.total-cost span:last-child {
        color: var(--warning);
    }
    .summary-item.net-profit span:last-child {
        font-size: 28px;
        font-weight: 800;
    }
    .summary-item.net-profit {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed var(--input-border);
    }
    
    /* Theme Toggle Button & Language Select */
    .control-button {
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        cursor: pointer;
        font-size: 20px;
        color: var(--muted);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s, background 0.2s, border-color 0.2s;
        padding: 0;
    }
    .control-button:hover {
        color: var(--accent);
        border-color: var(--accent);
    }

    #langSelect {
        width: 60px;
        height: 40px;
        border-radius: 20px;
        padding: 0 10px;
        text-align: center;
        font-size: 16px;
    }

    
    /* Parts List Section (Replaces Notes) */
    #partsListSection {
        margin-top: 25px;
        padding: 18px;
        border-radius: var(--radius);
        background: var(--input-bg);
        border: 1px solid var(--input-border);
    }
    #partsListSection h4 {
        color: var(--accent);
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 18px;
        font-weight: 600;
    }
    #partsListSection ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }
    #partsListSection li {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
        line-height: 1.5;
        font-weight: 500;
    }
    #partsListSection li span:first-child {
        color: var(--muted);
    }

  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1 data-i18n-key="title">IPPM Analyzer Analyzer</h1>
        <p class="lead" data-i18n-key="lead">Made by Tal Ravid</p>
      </div>
      <div class="header-controls">
        <button id="themeToggle" class="control-button" title="Toggle Day/Night Mode">‚òÄÔ∏è</button>
        <select id="langSelect">
            <option value="en" selected>EN</option>
            <option value="he">HE</option>
        </select>
      </div>
    </header>

    <div class="main">
      <div class="right">
        <h2 data-i18n-key="details_h2">Device Details & Repair Costs (ILS)</h2>
        
        <div class="form-group">
          <label for="modelSelect" data-i18n-key="device_model">Device Model</label>
          <select id="modelSelect">
            <option value="iphone 16 pro max">iPhone 16 Pro Max 256GB</option>
            <option value="iphone 15 pro max">iPhone 15 Pro Max 256GB</option>
            <option value="iphone 14 pro max">iPhone 14 Pro Max 256GB</option>
          </select>
        </div>

        <div class="form-group">
            <label for="batteryHealthSlider" data-i18n-key="battery_health">Battery Health (%)</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="range" min="80" max="100" value="100" class="slider" id="batteryHealthSlider" style="flex-grow: 1;">
                <input type="number" min="80" max="100" value="100" id="batteryHealthInput" style="width: 65px; text-align: center;">
            </div>
            <div id="batteryPenaltyDisplay" style="color: var(--warning); font-size: 12px; margin-top: 5px;"></div>
        </div>

        <div class="form-group">
            <label data-i18n-key="defects_label">Defects and Repair Items (ILS)</label>
            <div id="issuesList">
                <span data-i18n-key="select_model_prompt">Please select a model to load issues.</span>
            </div>
        </div>
        
        <div class="form-group">
            <label for="additionalCostsInput" data-i18n-key="additional_costs">Additional Purchase Overhead (Fuel/Misc Fees) ‚Ç™</label>
            <input type="number" id="additionalCostsInput" value="0" min="0">
        </div>

        <div class="form-group">
            <label for="platformFeeInput" data-i18n-key="platform_fee">Selling Platform Fee / Commission ‚Ç™</label>
            <input type="number" id="platformFeeInput" value="0" min="0">
        </div>

      </div>

      <div class="left">
        <h2 data-i18n-key="analysis_h2">Profitability Analysis (ILS)</h2>
        
        <div class="form-group">
            <label for="likeNewInput" data-i18n-key="target_sell_price">Target Selling Price (Mint Condition) ‚Ç™</label>
            <div class="input-with-btns">
                <input type="number" id="likeNewInput" value="0" min="1000">
                <div class="btn-group">
                    <button id="likeNewUp">+</button>
                    <button id="likeNewDown">-</button>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="actualOfferInput" data-i18n-key="actual_offer_price">Actual Purchase Price (Offer to Seller) ‚Ç™</label>
            <div class="input-with-btns">
                <input type="number" id="actualOfferInput" value="0" min="0">
                <div class="btn-group">
                    <button id="offerUp">+</button>
                    <button id="offerDown">-</button>
                </div>
                
            </div>
        </div>
        
        <div class="summary-box">
            <h4 data-i18n-key="financial_breakdown">Financial Breakdown:</h4>
            
            <div class="summary-item total-offer">
                <span data-i18n-key="max_offer">MAX Break-Even Offer</span>
                <span id="maxOfferDisplay">0 ‚Ç™</span>
            </div>
            <hr style="border-color:var(--input-border); margin: 10px 0;">

            <div class="summary-item">
                <span data-i18n-key="total_parts_cost">Total Parts Cost (Cash Expense)</span>
                <span id="totalPartsCostDisplay">0 ‚Ç™</span>
            </div>
            <div class="summary-item">
                <span data-i18n-key="labor_value">Repair Labor Value (Your Potential Profit)</span>
                <span id="totalLaborCostDisplay">0 ‚Ç™</span>
            </div>
            <div class="summary-item total-cost">
                <span data-i18n-key="total_cash_investment">Total Cash Investment (Offer + Expenses)</span>
                <span id="totalCostDisplay">0 ‚Ç™</span>
            </div>
            <div class="summary-item profit-margin">
                <span data-i18n-key="expected_margin">Expected Total Profit Margin (Includes Labor)</span>
                <span id="profitMarginDisplay">0%</span>
            </div>
            <div class="summary-item net-profit">
                <span data-i18n-key="net_cash_profit">Expected **Net Cash** Profit</span>
                <span id="netProfitDisplay">0 ‚Ç™</span>
            </div>
        </div>
        
        <div id="partsListSection">
            </div>
        
      </div>
    </div>
  </div>

  <script>
    const dom = {};
    const CURRENCY_SYMBOL = ' ‚Ç™'; 
    const TAX_MULTIPLIER = 1.17; 
    const BATTERY_CRITICAL_THRESHOLD = 88;
    
    let adjustableLikeNew = 0;
    let adjustableActualOffer = 0; 
    let currentLang = 'en';

    // --- I18N Translation Object ---
    const i18n = {
        'en': {
            'title': 'IPPM Repair Cost Calculator ',
            'lead': 'Made by Tal Ravid.',
            'details_h2': 'Device Details & Repair Costs (ILS)',
            'device_model': 'Device Model',
            'battery_health': 'Battery Health (%)',
            'defects_label': 'Defects and Repair Items (ILS)',
            'select_model_prompt': 'Please select a model to load issues.',
            'additional_costs': 'Additional Trade Fee (Bus/Train/etc) ‚Ç™',
            'platform_fee': 'Selling Platform Fee / Commission ‚Ç™',
            'analysis_h2': 'Profitability Analysis (ILS)',
            'target_sell_price': 'Target Selling Price (Mint Condition) ‚Ç™',
            'actual_offer_price': 'Actual Purchase Price (Offer to Seller) ‚Ç™',
            'financial_breakdown': 'Financial Breakdown:',
            'max_offer': 'MAX Break-Even Offer',
            'total_parts_cost': 'Total Parts Cost (Cash Expense)',
            'labor_value': 'Repair Labor Value (Your Potential Profit)',
            'total_cash_investment': 'Total Cash Investment (Offer + Expenses)',
            'expected_margin': 'Expected Total Profit Margin (Includes Labor)',
            'net_cash_profit': 'Expected **Net Cash** Profit',
            'parts_list_h4': 'Required Parts and Cash Cost',
            'parts_cost_label': 'Parts Cost (Base Price):',
            'labor_value_label': 'Labor Value:',
            'total_repair_cost': 'Total Repair Cost:',
            'battery_critical': '**CRITICAL THRESHOLD!** Battery health at {health}%. Estimated replacement cost: {cost}{symbol}. This cost is included via the auto-checked \'Battery <88%\' issue.',
            'issue_broken_back': 'Broken Back Glass',
            'issue_broken_screen': 'Broken Screen (Glass Only)',
            'issue_broken_lcd': 'Broken Screen + LCD',
            'issue_battery_low': 'Battery <88%',
            'issue_camera_issues': 'Camera Replacement',
            'issue_lens_broken': 'Broken Lens x1',
            'no_parts_needed': 'No parts are required for this trade.',
            'cash_cost': 'Cash Cost (Parts + VAT)'
        },
        'he': {
            'title': '◊û◊ó◊©◊ë◊ï◊ü ◊û◊ó◊ô◊®◊ô ◊™◊ô◊ß◊ï◊ü ◊ï◊û◊õ◊ô◊®◊î',
            'lead': '◊†◊ë◊†◊î ◊¢◊ú ◊ô◊ì◊ô ◊ò◊ú ◊®◊ë◊ô◊ì.',
            'details_h2': '◊§◊®◊ò◊ô ◊û◊õ◊©◊ô◊® ◊ï◊¢◊ú◊ï◊ô◊ï◊™ ◊™◊ô◊ß◊ï◊ü (‚Ç™)',
            'device_model': '◊ì◊í◊ù ◊î◊û◊õ◊©◊ô◊®',
            'battery_health': '◊ë◊®◊ô◊ê◊ï◊™ ◊°◊ï◊ú◊ú◊î (%)',
            'defects_label': '◊§◊í◊û◊ô◊ù ◊ï◊®◊õ◊ô◊ë◊ô ◊™◊ô◊ß◊ï◊ü (‚Ç™)',
            'select_model_prompt': '◊ê◊†◊ê ◊ë◊ó◊® ◊ì◊í◊ù ◊õ◊ì◊ô ◊ú◊ò◊¢◊ï◊ü ◊§◊í◊û◊ô◊ù.',
            'additional_costs': '◊¢◊ú◊ï◊ô◊ï◊™ ◊®◊õ◊ô◊©◊î ◊†◊ï◊°◊§◊ï◊™ ◊†◊°◊ô◊¢◊ï◊™ ◊ï◊©◊ï◊†◊ï◊™) ‚Ç™',
            'platform_fee': '◊¢◊û◊ú◊™ ◊§◊ú◊ò◊§◊ï◊®◊û◊™ ◊û◊õ◊ô◊®◊î / ◊¢◊û◊ú◊î ‚Ç™',
            'analysis_h2': '◊†◊ô◊™◊ï◊ó ◊®◊ï◊ï◊ó◊ô◊ï◊™ (‚Ç™)',
            'target_sell_price': '◊û◊ó◊ô◊® ◊û◊õ◊ô◊®◊î ◊ô◊¢◊ì (◊û◊¶◊ë ◊ó◊ì◊©) ‚Ç™',
            'actual_offer_price': '◊û◊ó◊ô◊® ◊®◊õ◊ô◊©◊î ◊ë◊§◊ï◊¢◊ú (◊î◊¶◊¢◊î ◊ú◊û◊ï◊õ◊®) ‚Ç™',
            'financial_breakdown': '◊§◊ô◊®◊ï◊ò ◊§◊ô◊†◊†◊°◊ô:',
            'max_offer': '◊î◊¶◊¢◊™ ◊û◊ß◊°◊ô◊û◊ï◊ù (◊†◊ß◊ï◊ì◊™ ◊ê◊ô◊ñ◊ï◊ü)',
            'total_parts_cost': '◊°◊î"◊õ ◊¢◊ú◊ï◊™ ◊ó◊ú◊ß◊ô◊ù (◊î◊ï◊¶◊ê◊î ◊ë◊û◊ñ◊ï◊û◊ü)',
            'labor_value': '◊¢◊®◊ö ◊¢◊ë◊ï◊ì◊™ ◊™◊ô◊ß◊ï◊ü (◊î◊®◊ï◊ï◊ó ◊î◊§◊ï◊ò◊†◊¶◊ô◊ê◊ú◊ô ◊©◊ú◊ö)',
            'total_cash_investment': '◊°◊î"◊õ ◊î◊©◊ß◊¢◊î ◊ë◊û◊ñ◊ï◊û◊ü (◊î◊¶◊¢◊î + ◊î◊ï◊¶◊ê◊ï◊™)',
            'expected_margin': '◊®◊ï◊ï◊ó ◊©◊ï◊ú◊ô ◊õ◊ï◊ú◊ú ◊¶◊§◊ï◊ô (◊õ◊ï◊ú◊ú ◊¢◊ë◊ï◊ì◊î)',
            'net_cash_profit': '◊®◊ï◊ï◊ó **◊û◊ñ◊ï◊û◊ü ◊†◊ß◊ô** ◊¶◊§◊ï◊ô',
            'parts_list_h4': '◊ó◊ú◊ß◊ô◊ù ◊†◊ì◊®◊©◊ô◊ù ◊ï◊¢◊ú◊ï◊™ ◊û◊ñ◊ï◊û◊ü',
            'parts_cost_label': '◊¢◊ú◊ï◊™ ◊ó◊ú◊ß◊ô◊ù (◊û◊ó◊ô◊® ◊ë◊°◊ô◊°):',
            'labor_value_label': '◊¢◊®◊ö ◊¢◊ë◊ï◊ì◊î:',
            'total_repair_cost': '◊°◊î"◊õ ◊¢◊ú◊ï◊™ ◊™◊ô◊ß◊ï◊ü:',
            'battery_critical': '**◊°◊£ ◊ß◊®◊ô◊ò◊ô!** ◊ë◊®◊ô◊ê◊ï◊™ ◊°◊ï◊ú◊ú◊î ◊ë-{health}%. ◊¢◊ú◊ï◊™ ◊î◊ó◊ú◊§◊î ◊û◊©◊ï◊¢◊®◊™: {cost}{symbol}. ◊¢◊ú◊ï◊™ ◊ñ◊ï ◊†◊õ◊ú◊ú◊™ ◊ë◊ê◊û◊¶◊¢◊ï◊™ ◊î◊°◊ô◊û◊ï◊ü ◊î◊ê◊ï◊ò◊ï◊û◊ò◊ô ◊©◊ú \'◊°◊ï◊ú◊ú◊î <88%\'.',
            'issue_broken_back': '◊ñ◊õ◊ï◊õ◊ô◊™ ◊í◊ë ◊©◊ë◊ï◊®◊î',
            'issue_broken_screen': '◊û◊°◊ö ◊©◊ë◊ï◊® (◊ñ◊õ◊ï◊õ◊ô◊™ ◊ë◊ú◊ë◊ì)',
            'issue_broken_lcd': '◊û◊°◊ö + LCD ◊©◊ë◊ï◊®◊ô◊ù',
            'issue_battery_low': '◊°◊ï◊ú◊ú◊î <88%',
            'issue_camera_issues': '◊î◊ó◊ú◊§◊™ ◊û◊¶◊ú◊û◊î',
            'issue_lens_broken': '◊¢◊ì◊©◊î ◊©◊ë◊ï◊®◊î x1',
            'no_parts_needed': '◊ú◊ê ◊†◊ì◊®◊©◊ô◊ù ◊ó◊ú◊ß◊ô◊ù ◊¢◊ë◊ï◊® ◊¢◊°◊ß◊î ◊ñ◊ï.',
            'cash_cost': '◊¢◊ú◊ï◊™ ◊ë◊û◊ñ◊ï◊û◊ü (◊ó◊ú◊ß + ◊û◊¢"◊û)'
        }
    };
    
    // Model configuration - Using i18n keys for labels
    const modelConfig = {
      "iphone 16 pro max": {
        defaultLikeNew: 3400, defaultOffer: 3000,
        repairCosts: {
          "broken_back": { labelKey: 'issue_broken_back', parts: 25, labor: 250 },
          "broken_screen": { labelKey: 'issue_broken_screen', parts: 50, labor: 700 },
          "broken_lcd": { labelKey: 'issue_broken_lcd', parts: 540, labor: 400 }, 
          "battery_low": { labelKey: 'issue_battery_low', parts: 60, labor: 190 },
          "camera_issues": { labelKey: 'issue_camera_issues', parts: 180, labor: 420 },
          "lens_broken": { labelKey: 'issue_lens_broken', parts: 25, labor: 250 }
        }
      },
      "iphone 15 pro max": {
        defaultLikeNew: 2500, defaultOffer: 2000,
        repairCosts: {
          "broken_back": { labelKey: 'issue_broken_back', parts: 25, labor: 275 },
          "broken_screen": { labelKey: 'issue_broken_screen', parts: 50, labor: 700 },
          "broken_lcd": { labelKey: 'issue_broken_lcd', parts: 540, labor: 400 },
          "battery_low": { labelKey: 'issue_battery_low', parts: 60, labor: 190 },
          "camera_issues": { labelKey: 'issue_camera_issues', parts: 180, labor: 420 },
          "lens_broken": { labelKey: 'issue_lens_broken', parts: 25, labor: 250 }
        }
      },
      "iphone 14 pro max": {
        defaultLikeNew: 1900, defaultOffer: 1500,
        repairCosts: {
          "broken_back": { labelKey: 'issue_broken_back', parts: 25, labor: 275 },
          "broken_screen": { labelKey: 'issue_broken_screen', parts: 50, labor: 700 },
          "broken_lcd": { labelKey: 'issue_broken_lcd', parts: 540, labor: 400 },
          "battery_low": { labelKey: 'issue_battery_low', parts: 60, labor: 190 },
          "camera_issues": { labelKey: 'issue_camera_issues', parts: 180, labor: 420 },
          "lens_broken": { labelKey: 'issue_lens_broken', parts: 25, labor: 250 }
        }
      }
    };

    function getDOMElements() {
      dom.modelSelect = document.getElementById('modelSelect');
      dom.likeNewInput = document.getElementById('likeNewInput');
      dom.likeNewUp = document.getElementById('likeNewUp');
      dom.likeNewDown = document.getElementById('likeNewDown');
      
      dom.actualOfferInput = document.getElementById('actualOfferInput'); 
      dom.offerUp = document.getElementById('offerUp');
      dom.offerDown = document.getElementById('offerDown');

      dom.maxOfferDisplay = document.getElementById('maxOfferDisplay'); 
      
      dom.issuesList = document.getElementById('issuesList');
      dom.batteryHealthSlider = document.getElementById('batteryHealthSlider');
      dom.batteryHealthInput = document.getElementById('batteryHealthInput');
      dom.batteryPenaltyDisplay = document.getElementById('batteryPenaltyDisplay');
      dom.additionalCostsInput = document.getElementById('additionalCostsInput');
      dom.platformFeeInput = document.getElementById('platformFeeInput');
      
      dom.totalPartsCostDisplay = document.getElementById('totalPartsCostDisplay');
      dom.totalLaborCostDisplay = document.getElementById('totalLaborCostDisplay'); 
      dom.totalCostDisplay = document.getElementById('totalCostDisplay');
      dom.netProfitDisplay = document.getElementById('netProfitDisplay');
      dom.profitMarginDisplay = document.getElementById('profitMarginDisplay');
      
      dom.themeToggle = document.getElementById('themeToggle'); 
      dom.langSelect = document.getElementById('langSelect');
      dom.partsListSection = document.getElementById('partsListSection'); 
    }

    function getCurrentModelConfig() {
      const selectedModel = dom.modelSelect.value;
      return modelConfig[selectedModel] || { defaultLikeNew: 0, defaultOffer: 0, repairCosts: {} };
    }

    // --- I18N Logic ---
    function setLanguage(lang) {
        currentLang = lang;
        document.documentElement.setAttribute('lang', lang);
        document.documentElement.setAttribute('dir', lang === 'he' ? 'rtl' : 'ltr');
        
        // Update static DOM elements
        document.querySelectorAll('[data-i18n-key]').forEach(el => {
            const key = el.getAttribute('data-i18n-key');
            el.textContent = i18n[lang][key] || el.textContent;
        });

        // Re-render dynamic content
        updateSummary();
        renderIssues();
    }
    
    function translate(key, replacements = {}) {
        let text = i18n[currentLang][key] || i18n['en'][key] || `Missing key: ${key}`;
        
        for (const [placeholder, value] of Object.entries(replacements)) {
            text = text.replace(new RegExp(`{${placeholder}}`, 'g'), value);
        }
        return text;
    }

    function toggleTheme() {
        const html = document.documentElement;
        if (html.getAttribute('data-theme') === 'light') {
            html.removeAttribute('data-theme'); // Switching to Dark
            dom.themeToggle.innerHTML = '‚òÄÔ∏è'; // Show Sun (for next switch to Light)
        } else {
            html.setAttribute('data-theme', 'light'); // Switching to Light
            dom.themeToggle.innerHTML = 'üåô'; // Show Moon (for next switch to Dark)
        }
        // No need to call updateSummary here as language change handles it
    }
    
    function calculateBatteryPenalty(health) {
      const modelCfg = getCurrentModelConfig();
      const batteryRepairCost = (modelCfg.repairCosts.battery_low.parts || 0) + (modelCfg.repairCosts.battery_low.labor || 0); 

      if (health > BATTERY_CRITICAL_THRESHOLD) { 
          dom.batteryPenaltyDisplay.innerHTML = '';
          return 0; 
      }
      
      if (health <= BATTERY_CRITICAL_THRESHOLD) {
          const cost = Math.round(batteryRepairCost).toLocaleString(currentLang === 'he' ? 'he-IL' : 'en-US');
          const symbol = CURRENCY_SYMBOL;
          const healthVal = health;

          dom.batteryPenaltyDisplay.innerHTML = translate('battery_critical', { health: healthVal, cost: cost, symbol: symbol });
          return 0; 
      } 
      
      return 0;
    }

    function updateLikeNew(newValue) {
      adjustableLikeNew = parseInt(newValue) || 0;
      dom.likeNewInput.value = adjustableLikeNew;
      updateSummary();
    }
    
    function updateActualOffer(newValue) {
      adjustableActualOffer = parseInt(newValue) || 0;
      dom.actualOfferInput.value = adjustableActualOffer;
      updateSummary();
    }

    function calculateRepairCosts() {
        let totalPartsCost = 0;
        let totalLaborCost = 0;
        let selectedIssues = [];

        dom.issuesList.querySelectorAll('.issue-checkbox:checked').forEach(checkbox => {
            const issueKey = checkbox.dataset.issueKey;
            
            const partsInput = dom.issuesList.querySelector(`.parts-cost-input[data-issue-key="${issueKey}"]`);
            const laborInput = dom.issuesList.querySelector(`.labor-cost-input[data-issue-key="${issueKey}"]`);
            
            let partsBase = parseInt(partsInput?.value || 0); 
            const laborCost = parseInt(laborInput?.value || 0);
            
            let partsCostFinal = partsBase;
            if (issueKey === 'broken_lcd') {
                partsCostFinal = partsBase * TAX_MULTIPLIER; 
            }
            
            totalPartsCost += partsCostFinal;
            totalLaborCost += laborCost;
            
            selectedIssues.push({
                key: issueKey,
                labelKey: getCurrentModelConfig().repairCosts[issueKey].labelKey,
                partsBase: partsBase,
                partsFinal: partsCostFinal,
                labor: laborCost
            });
        });
        
        return { 
            parts: totalPartsCost, 
            labor: totalLaborCost, 
            total: totalPartsCost + totalLaborCost,
            selectedIssues: selectedIssues
        };
    }

    function handleIssueClick(event) {
        const div = event.currentTarget;
        const checkbox = div.querySelector('.issue-checkbox');
        
        // Toggle the checkbox state UNLESS the clicked element is an input field
        const targetClass = event.target.classList;
        if (targetClass.contains('parts-cost-input') || targetClass.contains('labor-cost-input')) {
             // Do nothing if input is clicked, allow user to edit
             return; 
        }

        checkbox.checked = !checkbox.checked;
        handleIssueVisualUpdate(checkbox);
        updateSummary();
    }
    
    function handleIssueVisualUpdate(checkbox) {
        const parentDiv = checkbox.closest('[data-issue-id]');
        if (checkbox.checked) {
            parentDiv.classList.add('selected-issue');
        } else {
            parentDiv.classList.remove('selected-issue');
        }
    }

    function renderIssues() {
      const modelCfg = getCurrentModelConfig();
      const costs = modelCfg.repairCosts;
      let html = '';
      
      const partsCostLabel = translate('parts_cost_label');
      const laborValueLabel = translate('labor_value_label');
      const totalRepairCostLabel = translate('total_repair_cost');


      for (const key in costs) {
        const item = costs[key];
        
        let initialPartsForDisplay = item.parts;
        if (key === 'broken_lcd') {
            initialPartsForDisplay = item.parts * TAX_MULTIPLIER;
        }

        const initialLabor = item.labor;
        const totalRepairCost = initialPartsForDisplay + initialLabor; 
        
        html += `
          <div data-issue-id="${key}" class="issue-item">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" class="issue-checkbox" data-issue-key="${key}"> 
                  <span class="issue-label-text">${translate(item.labelKey)} (${totalRepairCostLabel} ${Math.round(totalRepairCost).toLocaleString(currentLang === 'he' ? 'he-IL' : 'en-US')}${CURRENCY_SYMBOL})</span>
              </label>
              <div class="issue-manual-cost">
                  <label>${partsCostLabel}</label>
                  <input type="number" class="parts-cost-input" data-issue-key="${key}" value="${Math.round(item.parts)}" min="0"> 
                  <label>${laborValueLabel}</label>
                  <input type="number" class="labor-cost-input" data-issue-key="${key}" value="${item.labor}" min="0">
              </div>
          </div>
        `;
      }

      dom.issuesList.innerHTML = html || `<span data-i18n-key="select_model_prompt">${translate('select_model_prompt')}</span>`;
      bindIssueEvents(); 
      dom.issuesList.querySelectorAll('.issue-checkbox').forEach(handleIssueVisualUpdate);
    }
    
    // NEW: Renders the Parts List
    function renderPartsList(repairCosts) {
        const selectedIssues = repairCosts.selectedIssues;
        let html = `<h4>${translate('parts_list_h4')}</h4><ul>`;
        
        if (selectedIssues.length === 0) {
            html += `<li><span style="color:var(--text);">${translate('no_parts_needed')}</span></li>`;
        } else {
            selectedIssues.forEach(issue => {
                let costLabel = '';
                // Only broken_lcd includes tax in the final cash cost calculation.
                if (issue.key === 'broken_lcd') {
                    costLabel = translate('cash_cost'); // Use specific label for taxed item
                } else {
                    costLabel = translate('total_parts_cost'); 
                }
                
                html += `<li>
                    <span>${translate(issue.labelKey)}</span>
                    <span style="font-weight:700;">${Math.round(issue.partsFinal).toLocaleString(currentLang === 'he' ? 'he-IL' : 'en-US')}${CURRENCY_SYMBOL}</span>
                </li>`;
            });
        }
        
        html += '</ul>';
        dom.partsListSection.innerHTML = html;
    }


    function updateSummary() {
      const actualOffer = adjustableActualOffer; 
      const likeNew = adjustableLikeNew; 
      const additionalCosts = parseInt(dom.additionalCostsInput.value) || 0;
      const platformFee = parseInt(dom.platformFeeInput.value) || 0;
      
      const currentBatteryHealth = parseInt(dom.batteryHealthInput.value);

      // --- Auto-check/Auto-uncheck Battery Issue Logic ---
      const batteryCheckbox = dom.issuesList.querySelector(`.issue-checkbox[data-issue-key="battery_low"]`);
      if (batteryCheckbox) {
          const isBatteryCritical = currentBatteryHealth <= BATTERY_CRITICAL_THRESHOLD;
          const needsVisualUpdate = batteryCheckbox.checked !== isBatteryCritical;
          
          batteryCheckbox.checked = isBatteryCritical;
          if (needsVisualUpdate) {
              handleIssueVisualUpdate(batteryCheckbox);
          }
      }
      
      const repairCosts = calculateRepairCosts(); 
      const batteryPenalty = calculateBatteryPenalty(currentBatteryHealth); 

      // 1. Total Cash Expenses 
      const cashExpenses = repairCosts.parts + additionalCosts + batteryPenalty + platformFee;

      // 2. Net Selling Price
      const netSellPrice = likeNew; 

      // 3. MAX Break-Even Offer
      const maxOffer = Math.max(0, Math.round(netSellPrice - cashExpenses));
      
      // 4. Total Cash Investment 
      const totalCashInvestment = actualOffer + cashExpenses; 
      
      // 5. Net Cash Profit
      const netCashProfit = netSellPrice - totalCashInvestment; 
      
      // 6. Total Expected Profit (for Margin calculation)
      const totalExpectedProfitForMargin = netCashProfit + repairCosts.labor; 
      
      // 7. Total Profit Margin (%)
      const profitMarginBase = netSellPrice;
      const profitMargin = profitMarginBase > 0 ? ((totalExpectedProfitForMargin / profitMarginBase) * 100).toFixed(1) : 0;
      
      // Formatting helper
      const formatNumber = (num) => num.toLocaleString(currentLang === 'he' ? 'he-IL' : 'en-US');

      // --- Update Display ---
      
      dom.maxOfferDisplay.textContent = `${formatNumber(maxOffer)}${CURRENCY_SYMBOL}`;

      dom.totalPartsCostDisplay.textContent = `${formatNumber(Math.round(repairCosts.parts))}${CURRENCY_SYMBOL}`;
      dom.totalLaborCostDisplay.textContent = `${formatNumber(repairCosts.labor)}${CURRENCY_SYMBOL}`; 
      dom.totalCostDisplay.textContent = `${formatNumber(Math.round(totalCashInvestment))}${CURRENCY_SYMBOL}`;
      dom.netProfitDisplay.textContent = `${formatNumber(Math.round(netCashProfit))}${CURRENCY_SYMBOL}`;
      dom.profitMarginDisplay.textContent = `${profitMargin}%`;

      // Coloring 
      const isProfitable = netCashProfit > 0;
      dom.netProfitDisplay.parentElement.style.color = isProfitable ? 'var(--success)' : 'var(--danger)';
      dom.profitMarginDisplay.parentElement.style.color = isProfitable ? 'var(--success)' : 'var(--danger)';
      
      // --- Update Parts List (REPLACED NOTES) ---
      renderPartsList(repairCosts);
    }

    function bindIssueEvents() {
        dom.issuesList.querySelectorAll('.issue-item').forEach(div => {
            div.removeEventListener('click', handleIssueClick); 
            div.addEventListener('click', handleIssueClick);
        });
        
        // Bind inputs for cost fields
        dom.issuesList.querySelectorAll('.parts-cost-input, .labor-cost-input').forEach(el => {
            el.removeEventListener('change', updateSummary); 
            el.removeEventListener('input', updateSummary);
            el.addEventListener('change', updateSummary);
            el.addEventListener('input', updateSummary);
        });
    }

    function bindEvents() {
      dom.themeToggle.addEventListener('click', toggleTheme); 
      dom.langSelect.addEventListener('change', (e) => setLanguage(e.target.value));

      dom.modelSelect.addEventListener('change', function () {
        const modelCfg = getCurrentModelConfig();
        updateLikeNew(modelCfg.defaultLikeNew); 
        updateActualOffer(modelCfg.defaultOffer); 
        renderIssues(); 
      });

      // Battery events
      dom.batteryHealthSlider.addEventListener('input', function() {
          dom.batteryHealthInput.value = this.value;
          updateSummary();
      });
      dom.batteryHealthInput.addEventListener('change', function() {
          dom.batteryHealthSlider.value = this.value;
          updateSummary();
      });
      
      // Like New Price events
      dom.likeNewInput.addEventListener('change', (e) => updateLikeNew(e.target.value));
      dom.likeNewUp.addEventListener('click', () => updateLikeNew(adjustableLikeNew + 50));
      dom.likeNewDown.addEventListener('click', () => updateLikeNew(adjustableLikeNew - 50));
      
      // Actual Offer Price events (Manual Input)
      dom.actualOfferInput.addEventListener('change', (e) => updateActualOffer(e.target.value));
      dom.offerUp.addEventListener('click', () => updateActualOffer(adjustableActualOffer + 50));
      dom.offerDown.addEventListener('click', () => updateActualOffer(adjustableActualOffer - 50));

      // Cost events
      dom.additionalCostsInput.addEventListener('change', updateSummary);
      dom.platformFeeInput.addEventListener('change', updateSummary);
    }

    function init() {
      getDOMElements();
      bindEvents();
      
      // Initialize language (default is English)
      setLanguage(dom.langSelect.value);

      const modelCfg = getCurrentModelConfig();
      updateLikeNew(modelCfg.defaultLikeNew);
      updateActualOffer(modelCfg.defaultOffer); 
      // renderIssues and updateSummary are called inside setLanguage
    }

    init();
  </script>
</body>
</html>      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .input-group label {
      font-size: 12px;
      color: var(--muted);
    }

    .input-group input {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #111;
      color: #e8eef0;
      font-size: 13px;
      transition: border-color 0.2s;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .input-group input::placeholder {
      color: #555;
    }

    #addTradeBtn {
      margin-top: 12px;
      background: var(--accent);
      border: none;
      border-radius: var(--radius);
      padding: 10px 14px;
      color: #0d0f11;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s, transform 0.1s;
      font-size:14px;
    }
    #addTradeBtn:hover {
      background: #22b6ce;
      transform: translateY(-1px);
    }

    #storedTrades {
      margin-top: 16px;
      background: #22282c;
      padding: 12px;
      border-radius: var(--radius);
      max-height: 300px;
      overflow-y: auto;
      font-size:13px;
    }
    .trade-item {
      background: #11151a;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      border:1px solid #2a2f33;
    }
    .trade-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .trade-meta {
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .trade-contact {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .trade-issues {
      font-size: 12px;
      color: var(--muted);
      margin-bottom:4px;
    }
    .trade-totals{
      font-size:12px;
    }
    .trade-link {
      margin-top: 6px;
      font-size: 12px;
    }
    .trade-link a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }
    .trade-link a:hover {
      text-decoration: underline;
    }

    .adjustable-number {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }
    .adjustable-number input[type="number"] {
      width: 80px;
      font-weight: 600;
      color: var(--accent);
      background-color: #111;
      border-radius: 8px;
      border: 1px solid #333;
      text-align: center;
      padding: 4px 8px;
      font-size: 18px;
      -moz-appearance: textfield; /* Remove default spin buttons */
    }
    .adjustable-number input[type="number"]::-webkit-inner-spin-button,
    .adjustable-number input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .adjust-buttons {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .adjust-button {
      cursor: pointer;
      background: var(--accent);
      border: none;
      border-radius: 4px;
      width: 22px;
      height: 14px;
      padding: 0;
      color: #0d0f11;
      font-weight: 700;
      line-height: 12px;
      user-select: none;
    }
    .adjust-button:active {
      background: #22b6ce;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>IPPM Calculator</h1>
      <p class="lead">by Tal Ravid</p>
    </div>
  </header>

  <main class="main">
    <section class="left">
      <label class="small">Model (256GB)</label>
      <select id="modelSelect">
        <option value="16promax">iPhone 16 Pro Max</option>
        <option value="15promax">iPhone 15 Pro Max</option>
      </select>

      <div class="boxes" id="issuesGrid"></div>

      <div class="contact-fields">
        <div class="input-group">
          <label for="tradeUrl">Marketplace listing URL (optional)</label>
          <input 
            type="url" 
            id="tradeUrl" 
            placeholder="https://www.yad2.co.il/... or Facebook link"
            autocomplete="off"
          />
        </div>

        <div class="contact-row">
          <div class="input-group">
            <label for="sellerPhone">Phone</label>
            <input 
              type="tel" 
              id="sellerPhone" 
              placeholder="05x-xxx-xxxx"
              autocomplete="off"
            />
          </div>

          <div class="input-group">
            <label for="sellerCity">City</label>
            <input 
              type="text" 
              id="sellerCity" 
              placeholder="Tel Aviv, Jerusalem..."
              autocomplete="off"
            />
          </div>
        </div>
      </div>

      <button id="addTradeBtn">ADD new trade</button>

      <div id="storedTrades"></div>
    </section>

    <aside class="right">
      <div class="row">
        <div>
          <div class="muted">Used‚ÄëLike‚ÄëNew price</div>
          <div class="adjustable-number">
            <input type="number" id="likeNewInput" step="5" min="0" />
            <div class="adjust-buttons">
              <button class="adjust-button" id="likeNewUp">&#9650;</button>
              <button class="adjust-button" id="likeNewDown">&#9660;</button>
            </div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="muted">Selected issues</div>
          <div id="selectedCount" class="big">0</div>
        </div>
      </div>

      <div class="summary-box">
        <div class="totals">
          <div class="line">
            <div class="muted">Parts cost</div>
            <div id="partsTotal">‚Ç™0</div>
          </div>
          <div class="line">
            <div class="muted">Labor cost</div>
            <div id="laborTotal">‚Ç™0</div>
          </div>
          <div class="line">
            <div class="muted">Repair total</div>
            <div id="repairTotal">‚Ç™0</div>
          </div>
          <div class="line">
            <div class="muted">Profit</div>
            <div id="profitDisplay">‚Ç™0</div>
          </div>
          <div class="line">
            <div style="font-weight:700">Offer / Fair buy price</div>
            <div class="adjustable-number">
              <input type="number" id="offerInput" step="5" min="0" />
              <div class="adjust-buttons">
                <button class="adjust-button" id="offerUp">&#9650;</button>
                <button class="adjust-button" id="offerDown">&#9660;</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </main>
</div>

<script>
(function () {
  'use strict';

  // ----- Configuration -----

  const MODELS = {
    '16promax': {
      label: 'iPhone 16 Pro Max (256GB)',
      defaultLikeNew: 3200,
      defaultOffer: 3000
    },
    '15promax': {
      label: 'iPhone 15 Pro Max (256GB)',
      defaultLikeNew: 2400,
      defaultOffer: 2200
    }
  };

  const DEFAULT_ISSUES = [
    { id: 'broken_back',  title: 'Broken Back Glass',         parts: 25,          labor: 275 },
    { id: 'broken_screen',title: 'Broken Screen (glassOnly)', parts: 50,          labor: 700 },
    { id: 'broken_lcd',   title: 'Broken Screen + LCD',       parts: 400 * 1.17,  labor: 400 },
    { id: 'battery_low',  title: 'Battery <80%',              parts: 60,          labor: 190 },
    { id: 'camera_issues',title: 'Camera Replacement',        parts: 180,         labor: 420 },
    { id: 'lens_broken',  title: 'Broken Lens x1',            parts: 25,          labor: 250 }
  ];

  const TRADE_STORAGE_KEY = 'phoneTrades';

  // ----- State -----

  let issues = deepClone(DEFAULT_ISSUES);
  const selectedIssueIds = new Set();

  // Adjustable prices state
  let adjustableLikeNew = 0;
  let adjustableOffer = 0;

  // ----- DOM cache -----

  const dom = {
    issuesGrid: document.getElementById('issuesGrid'),
    modelSelect: document.getElementById('modelSelect'),
    likeNewInput: document.getElementById('likeNewInput'),
    likeNewUp: document.getElementById('likeNewUp'),
    likeNewDown: document.getElementById('likeNewDown'),
    partsTotalEl: document.getElementById('partsTotal'),
    laborTotalEl: document.getElementById('laborTotal'),
    repairTotalEl: document.getElementById('repairTotal'),
    profitDisplayEl: document.getElementById('profitDisplay'),
    offerInput: document.getElementById('offerInput'),
    offerUp: document.getElementById('offerUp'),
    offerDown: document.getElementById('offerDown'),
    selectedCountEl: document.getElementById('selectedCount'),
    tradeUrlInput: document.getElementById('tradeUrl'),
    sellerPhoneInput: document.getElementById('sellerPhone'),
    sellerCityInput: document.getElementById('sellerCity'),
    addTradeBtn: document.getElementById('addTradeBtn'),
    storedTradesEl: document.getElementById('storedTrades')
  };

  // ----- Utilities -----

  function deepClone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  function formatCurrency(value) {
    const rounded = Math.round(Number.isFinite(value) ? value : 0);
    return '‚Ç™' + rounded;
  }

  function getCurrentModelKey() {
    return dom.modelSelect.value;
  }

  function getCurrentModelConfig() {
    return MODELS[getCurrentModelKey()];
  }

  function getSelectedIssues() {
    return issues.filter(issue => selectedIssueIds.has(issue.id));
  }

  function isValidUrl(str) {
    if (!str || !str.trim()) return false;
    try {
      const url = new URL(str);
      return url.protocol === 'http:' || url.protocol === 'https:';
    } catch {
      return false;
    }
  }

  // ----- Calculation logic -----

  function calculateTotals() {
    const selected = getSelectedIssues();

    let parts = 0;
    let labor = 0;

    selected.forEach(issue => {
      parts += Number(issue.parts) || 0;
      labor += Number(issue.labor) || 0;
    });

    const repair = parts + labor;
    // Use adjustableLikeNew and adjustableOffer for calculations
    // Ensure offer does not exceed likeNew
    const likeNew = adjustableLikeNew;
    let offer = adjustableOffer;
    if (offer > likeNew) offer = likeNew;

    // Profit = likeNew - offer - parts
    const profit = likeNew - offer - parts;

    return {
      likeNew,
      selectedIssues: selected,
      parts,
      labor,
      repair,
      offer,
      profit
    };
  }

  function updateSummary() {
    const totals = calculateTotals();

    // Update adjustable inputs display if needed (only when model changes)
    // dom.likeNewInput.value = adjustableLikeNew; // no because editable by user
    // dom.offerInput.value = adjustableOffer;

    dom.partsTotalEl.textContent    = formatCurrency(totals.parts);
    dom.laborTotalEl.textContent    = formatCurrency(totals.labor);
    dom.repairTotalEl.textContent   = formatCurrency(totals.repair);
    dom.profitDisplayEl.textContent = formatCurrency(totals.profit);

    // Show likeNew and offer inputs formatted with ‚Ç™ for display
    dom.likeNewInput.value = totals.likeNew;
    dom.offerInput.value = totals.offer;

    dom.selectedCountEl.textContent = selectedIssueIds.size;

    return totals;
  }

  // ----- Issue cards UI -----

  function buildIssueCard(issue) {
    const card = document.createElement('div');
    card.className = 'issue';
    card.dataset.id = issue.id;
    if (selectedIssueIds.has(issue.id)) {
      card.classList.add('checked');
    }

    const head = document.createElement('div');
    head.className = 'issue-head';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = selectedIssueIds.has(issue.id);

    const title = document.createElement('div');
    title.className = 'issue-title';
    title.textContent = issue.title;

    head.appendChild(checkbox);
    head.appendChild(title);

    const sub = document.createElement('div');
    sub.className = 'issue-sub';
    sub.textContent = 'Parts + labor (editable per trade)';

    const row = document.createElement('div');
    row.className = 'parts-row';

    const partsField = document.createElement('div');
    partsField.className = 'field';
    const partsLabel = document.createElement('span');
    partsLabel.textContent = 'Parts';
    const partsInput = document.createElement('input');
    partsInput.type = 'number';
    partsInput.min = '0';
    partsInput.value = issue.parts;
    partsInput.inputMode = 'decimal';

    partsField.appendChild(partsLabel);
    partsField.appendChild(partsInput);

    const laborField = document.createElement('div');
    laborField.className = 'field';
    const laborLabel = document.createElement('span');
    laborLabel.textContent = 'Labor';
    const laborInput = document.createElement('input');
    laborInput.type = 'number';
    laborInput.min = '0';
    laborInput.value = issue.labor;
    laborInput.inputMode = 'decimal';

    laborField.appendChild(laborLabel);
    laborField.appendChild(laborInput);

    row.appendChild(partsField);
    row.appendChild(laborField);

    card.appendChild(head);
    card.appendChild(sub);
    card.appendChild(row);

    // Event wiring

    checkbox.addEventListener('change', function () {
      toggleIssueSelection(issue.id, checkbox.checked, card);
    });

    card.addEventListener('click', function (event) {
      const target = event.target;
      if (target === checkbox || target === partsInput || target === laborInput) {
        return;
      }
      const willSelect = !checkbox.checked;
      checkbox.checked = willSelect;
      toggleIssueSelection(issue.id, willSelect, card);
    });

    partsInput.addEventListener('input', function () {
      const val = parseFloat(partsInput.value);
      issue.parts = Number.isFinite(val) ? val : 0;
      updateSummary();
    });

    laborInput.addEventListener('input', function () {
      const val = parseFloat(laborInput.value);
      issue.labor = Number.isFinite(val) ? val : 0;
      updateSummary();
    });

    return card;
  }

  function toggleIssueSelection(issueId, isOn, cardNode) {
    if (isOn) {
      selectedIssueIds.add(issueId);
      cardNode.classList.add('checked');
    } else {
      selectedIssueIds.delete(issueId);
      cardNode.classList.remove('checked');
    }
    updateSummary();
  }

  function renderIssues() {
    dom.issuesGrid.innerHTML = '';
    issues.forEach(issue => {
      const card = buildIssueCard(issue);
      dom.issuesGrid.appendChild(card);
    });
  }

  // ----- Trades storage -----

  function loadTrades() {
    try {
      const raw = sessionStorage.getItem(TRADE_STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch (err) {
      return [];
    }
  }

  function saveTrades(trades) {
    try {
      sessionStorage.setItem(TRADE_STORAGE_KEY, JSON.stringify(trades));
    } catch (err) {
      // Ignore storage errors
    }
  }

  function addTradeToStorage(trade) {
    let trades = loadTrades();
    trades.push(trade);

    // Keep only the last 5 trades (newest at the end).
    if (trades.length > 5) {
      trades = trades.slice(trades.length - 5);
    }

    saveTrades(trades);
    return trades;
  }

  // ----- Trades UI -----

  function humanReadableModel(key) {
    const cfg = MODELS[key];
    return cfg ? cfg.label : key;
  }

  function renderStoredTrades(trades = loadTrades()) {
    const container = dom.storedTradesEl;
    container.innerHTML = '';

    if (!trades.length) {
      const empty = document.createElement('div');
      empty.className = 'muted';
      empty.textContent = 'No trades stored this session.';
      container.appendChild(empty);
      return;
    }

    const header = document.createElement('div');
    header.className = 'muted';
    header.style.marginBottom = '8px';
    header.textContent = 'Recent trades (max 5 for this session):';
    container.appendChild(header);

    trades.forEach(trade => {
      const item = document.createElement('div');
      item.className = 'trade-item';

      const title = document.createElement('div');
      title.className = 'trade-title';
      title.textContent = humanReadableModel(trade.model);

      const meta = document.createElement('div');
      meta.className = 'trade-meta';
      meta.textContent = `Like‚ÄëNew: ${formatCurrency(trade.likeNew)} ‚Ä¢ Added: ${trade.timestamp}`;

      // Contact info (phone and city)
      const contactParts = [];
      if (trade.phone) contactParts.push(`Phone: ${trade.phone}`);
      if (trade.city) contactParts.push(`City: ${trade.city}`);
      
      if (contactParts.length > 0) {
        const contactDiv = document.createElement('div');
        contactDiv.className = 'trade-contact';
        contactDiv.textContent = contactParts.join(' ‚Ä¢ ');
        item.appendChild(title);
        item.appendChild(meta);
        item.appendChild(contactDiv);
      } else {
        item.appendChild(title);
        item.appendChild(meta);
      }

      const issuesText = document.createElement('div');
      issuesText.className = 'trade-issues';
      const issueTitles = trade.selectedIssues && trade.selectedIssues.length
        ? trade.selectedIssues.map(i => i.title).join(', ')
        : 'None';
      issuesText.textContent = 'Issues: ' + issueTitles;

      const totals = document.createElement('div');
      totals.className = 'trade-totals';
      totals.innerHTML =
        `Parts: ${formatCurrency(trade.parts)} &nbsp;|&nbsp; ` +
        `Labor: ${formatCurrency(trade.labor)} &nbsp;|&nbsp; ` +
        `Repair: ${formatCurrency(trade.repair)}<br>` +
        `Offer: ${formatCurrency(trade.offer)} &nbsp;|&nbsp; ` +
        `Profit: ${formatCurrency(trade.profit)}`;

      item.appendChild(issuesText);
      item.appendChild(totals);

      // Add link if present
      if (trade.url && isValidUrl(trade.url)) {
        const linkDiv = document.createElement('div');
        linkDiv.className = 'trade-link';
        const anchor = document.createElement('a');
        anchor.href = trade.url;
        anchor.target = '_blank';
        anchor.rel = 'noopener noreferrer';
        anchor.textContent = 'Link';
        linkDiv.appendChild(anchor);
        item.appendChild(linkDiv);
      }

      container.appendChild(item);
    });
  }

  // ----- Actions -----

  function buildTradeObject() {
    const modelKey = getCurrentModelKey();
    const totals = calculateTotals();
    const now = new Date();
    const urlValue = dom.tradeUrlInput.value.trim();
    const phoneValue = dom.sellerPhoneInput.value.trim();
    const cityValue = dom.sellerCityInput.value.trim();

    return {
      id: now.getTime(),
      model: modelKey,
      likeNew: totals.likeNew,
      selectedIssues: totals.selectedIssues.map(i => ({
        id: i.id,
        title: i.title,
        parts: i.parts,
        labor: i.labor
      })),
      parts: totals.parts,
      labor: totals.labor,
      repair: totals.repair,
      offer: totals.offer,
      profit: totals.profit,
      url: urlValue && isValidUrl(urlValue) ? urlValue : null,
      phone: phoneValue || null,
      city: cityValue || null,
      timestamp: now.toLocaleString()
    };
  }

  function resetCalculator() {
    // Reset issues to defaults and clear selections.
    issues = deepClone(DEFAULT_ISSUES);
    selectedIssueIds.clear();

    // Reset adjustable prices to current model defaults
    const modelCfg = getCurrentModelConfig();
    adjustableLikeNew = modelCfg.defaultLikeNew;
    adjustableOffer = modelCfg.defaultOffer;

    // Clear all contact fields
    dom.tradeUrlInput.value = '';
    dom.sellerPhoneInput.value = '';
    dom.sellerCityInput.value = '';

    renderIssues();
    updateSummary();
  }

  function handleAddTradeClick() {
    const trade = buildTradeObject();
    const trades = addTradeToStorage(trade);
    renderStoredTrades(trades);
    resetCalculator();
  }

  // ----- Adjustable input handlers -----

  function clampToStep(val, step = 5) {
    return Math.round(val / step) * step;
  }

  function clampNonNegative(val) {
    return val < 0 ? 0 : val;
  }

  function incrementValue(value, step = 5) {
    return clampNonNegative(value + step);
  }

  function decrementValue(value, step = 5) {
    return clampNonNegative(value - step);
  }

  function updateLikeNew(value) {
    const modelCfg = getCurrentModelConfig();
    adjustableLikeNew = clampToStep(Number(value), 5);
    if (adjustableLikeNew < adjustableOffer) {
      // Adjust offer down to likeNew if greater
      adjustableOffer = adjustableLikeNew;
    }
    updateSummary();
  }

  function updateOffer(value) {
    const modelCfg = getCurrentModelConfig();
    adjustableOffer = clampToStep(Number(value), 5);
    if (adjustableOffer > adjustableLikeNew) {
      adjustableOffer = adjustableLikeNew;
    }
    updateSummary();
  }

  // ----- Initialization -----

  function bindEvents() {
    dom.modelSelect.addEventListener('change', function () {
      const modelCfg = getCurrentModelConfig();
      adjustableLikeNew = modelCfg.defaultLikeNew;
      adjustableOffer = modelCfg.defaultOffer;
      renderIssues();
      updateSummary();
    });

    dom.addTradeBtn.addEventListener('click', handleAddTradeClick);

    // LikeNew input events
    dom.likeNewInput.addEventListener('change', (e) => {
      updateLikeNew(e.target.value);
    });
    dom.likeNewInput.addEventListener('input', (e) => {
      // optional live update?
    });
    dom.likeNewUp.addEventListener('click', () => {
      updateLikeNew(adjustableLikeNew + 5);
    });
    dom.likeNewDown.addEventListener('click', () => {
      updateLikeNew(adjustableLikeNew - 5);
    });

    // Offer input events
    dom.offerInput.addEventListener('change', (e) => {
      updateOffer(e.target.value);
    });
    dom.offerInput.addEventListener('input', (e) => {
      // optional live update?
    });
    dom.offerUp.addEventListener('click', () => {
      updateOffer(adjustableOffer + 5);
    });
    dom.offerDown.addEventListener('click', () => {
      updateOffer(adjustableOffer - 5);
    });
  }

  function init() {
    const modelCfg = getCurrentModelConfig();
    adjustableLikeNew = modelCfg.defaultLikeNew;
    adjustableOffer = modelCfg.defaultOffer;
    renderIssues();
    updateSummary();
    renderStoredTrades();
    bindEvents();
  }

  init();
})();
</script>
</body>
</html>
